# GitLab CI script for yandasoft

image: registry.gitlab.com/askapsdp/yandasoft_image/yandasoft:casacore3.5.0-mpich

variables:
  GIT_SUBMODULE_STRATEGY: recursive
.common: {tags: [askapsdp]}

stages:
  - build
  - test
  - pages
  - ci_status

build:
  extends: .common
  stage: build
  before_script:
    - sudo apt update && sudo apt install -y g++ git cmake  
    - sudo ln -s /usr/lib/x86_64-linux-gnu/ /usr/lib64
  script:
    - n_cpus=`grep '^processor' /proc/cpuinfo  | wc -l`
    - cmake -C .gitlab-ci.cmake.in -DASKAPSDP_GIT_URL="https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.com/ASKAPSDP/" -DENABLE_OPENMP=OFF -DCMAKE_INSTALL_PREFIX=./_install -DCMAKE_BUILD_TYPE=Release -DCMAKE_CXX_FLAGS="-coverage" -DCMAKE_EXE_LINKER_FLAGS="-coverage" "-DASKAP_DEBUG" -B _build -S .
    # - cmake -C .gitlab-ci.cmake.in -DASKAPSDP_GIT_URL="https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.com/ASKAPSDP/" -DENABLE_OPENMP=OFF -DCMAKE_INSTALL_PREFIX=./_install -DCMAKE_BUILD_TYPE=Release -DCMAKE_CXX_FLAGS="-coverage" -DCMAKE_EXE_LINKER_FLAGS="-coverage"  -B _build -S .
    # - sed -i '/CMAKE_CXX_FLAGS_RELEASE:STRING/c\CMAKE_CXX_FLAGS_RELEASE:STRING=-O3' _build/CMakeCache.txt
    # - sed -i '/CMAKE_C_FLAGS_RELEASE:STRING/c\CMAKE_C_FLAGS_RELEASE:STRING=-O3' _build/CMakeCache.txt
    - sudo cmake --build _build --target install -j $n_cpus
  artifacts:
    paths:
      - _build
      - _install

test:
  extends: .common
  stage: test
  dependencies:
    - build
  before_script:
    - sudo apt update && sudo apt install -y cmake xsltproc 
  variables:
    CASARCFILES: ${CI_PROJECT_DIR}/_build/test_gitlab_casarc.cfg
    TEST_DATASET_PATH: ${CI_PROJECT_DIR}/_build/testdataset.ms
  script:
    - cd _build
    - tar -xjf base-accessors/measdata.tar.bz2
    - "echo 'measures.directory: '${PWD}'/data' > ${CASARCFILES}"
    - cat $CASARCFILES
    - tar -xjf base-accessors/testdataset.tar.bz2
    - ctest -C DartConfiguration.tcl -T test --verbose --no-compress-output
  after_script:
    - cd _build
    - askap-cmake/ctest2junit > ctest.xml
  artifacts:
    paths:
      - _build
    reports:
      junit: _build/ctest.xml
    when: always

robottests:
  extends: .common
  stage: test
  dependencies:
     - build
  before_script:
     - pip install robotframework
  script:
    - export CDIR=${PWD}
# setup path and library path to ensure we're testing the right thing
# See also AXA-1996 - got caught up by the lack of these lines earlier
    - export PATH=${CDIR}/_install/bin:${PATH}
    - export LD_LIBRARY_PATH=${CDIR}/_install/lib:${LD_LIBRARY_PATH}
    - which cimager
    - cd tests/data/simulation/synthregression
    - python -m robot synthregression.robot
  artifacts:
    paths:
      - tests/data/simulation/synthregression    
      - _build
    when: always

pages:
  extends: .common
  stage: pages
  dependencies:
    - test
  before_script:
    - sudo apt update && sudo apt install -y gcovr curl doxygen graphviz
  script:
    - mkdir -p public/build/reports
    - mkdir -p public/coverage
    - gcovr -r . -e '.*/CompilerIdCXX/.*' -e '.*/test/.*' --html --html-details -o public/coverage/index.html
    - gcovr -r . -e '.*/CompilerIdCXX/.*' -e '.*/test/.*' --xml -o public/build/reports/code-coverage.xml
    - cp _build/ctest.xml public/build/reports/unit-tests.xml
    - doxygen doxy.conf && mv html public/doxygen
    - cd public
  artifacts:
    paths:
      - ${CI_PROJECT_DIR}/public

success:
  stage: ci_status
  before_script:
    - sudo apt update && sudo apt install -y curl
  after_script:
    - ""
  script:
    - BUILD_STATUS=passed BUILD_KEY=push ./build_status
    - >
      if [ "$CI_COMMIT_BRANCH" = develop ]; then
        curl --request POST --form "token=$CI_JOB_TOKEN" --form ref=develop https://gitlab.com/api/v4/projects/19044771/trigger/pipeline
      fi
    - >
  when: on_success

failure:
  stage: ci_status
  before_script:
    - sudo apt update && sudo apt install -y curl
  after_script:
    - ""
  script:
    - BUILD_STATUS=failed BUILD_KEY=push ./build_status
  when: on_failure

